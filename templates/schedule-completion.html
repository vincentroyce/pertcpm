{{ define "title" }}
<title>{{ .Title }}</title>
{{ end }}
{{ define "content" }}
<div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="exampleModalLabel">Modal title</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        ...
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
<div class="container">
  <h1>Schedule Completion</h1>
  <h2>Project Title: <span class="project-title">{{ .ProjectName }}</span></h2>
</div>
<div class="container">
  <table class="table table-bordered table-hover">
    <thead class="thead-dark text-center">
      <tr>
        <th class="text-light" scope="col">Item No.</th>
        <th class="text-light" scope="col">Activity</th>
        <th class="text-light" scope="col">Immediate Predecessors</th>
        <th class="text-light" scope="col">Expected Time</th>
      </tr>
    </thead>
    <tbody class="text-center">
      {{range .Project.Phase}}
      <tr>
        <th class="fs-6" scope="row">{{ .No }}</th>
        <td class="fs-6">{{ .Name }}</td>
        <td colspan="2"></td>
      </tr>
      {{range .Activity}}
      {{$activity := .}}
      <tr>
        <th class="fs-6" scope="row">{{ .No }}</th>
        <td class="fs-6">{{ .Name }}</td>
        <td colspan="2"></td>
      </tr>
      {{range .SubActivity}}
      {{$subActivity := .}}
      <tr>
        <th class="fs-6" scope="row">{{ .No }}</th>
        <td class="fs-6">{{ .Name }}</td>
        <td class="p-0">
          <div class="dropdown w-100">
            <button class="btn btn-secondary dropdown-toggle w-100 pt-4 pb-4" type="button" id="dropdownMenuButton-{{.ID}}" data-bs-toggle="dropdown" aria-expanded="false">
              Select Predecessors
            </button>
            <div class="dropdown-menu w-100 text-center" aria-labelledby="dropdownMenuButton-{{.ID}}">
              <a class="dropdown-item" href="#">
                <input class="d-none" type="checkbox" value="0" class="predecessor-checkbox" data-no="Start"> Start
              </a>
              {{range $.AllSubActivities}}
                {{if ne .ID $subActivity.ID}}
                  <a class="dropdown-item" href="#">
                    <input class="d-none" type="checkbox" value="{{ .ID }}" class="predecessor-checkbox" data-no="{{ .No }}"> {{ .No }}
                  </a>
                {{end}}
              {{end}}
            </div>
          </div>
        </td>
        <td class="fs-6">{{ .ExpectedTime }}</td>
      </tr>
      {{end}}
      {{end}}
      {{end}}
    </tbody>
  </table>
  <div class="d-flex gap-4 justify-start">
    <button class="complete-schedule btn btn-success mt-2 mb-2" type="button">Complete Schedule</button>
    <button class="view-pert btn btn-info mt-2 mb-2" type="button" data-bs-target="#exampleModal">View PERT Diagram</button>
  </div>
</div>

<script>
  $(document).ready(function () {
    // Ensure event listeners are only added once
    $('.dropdown-item').off('click').on('click', function (e) {
      e.preventDefault();
      var checkbox = $(this).find('input[type="checkbox"]');
      var subActivityId = $(this).closest('.dropdown').find('.dropdown-toggle').attr('id').split('-')[1];
      var selectedPredecessors = [];

      // Toggle checkbox state
      checkbox.prop('checked', !checkbox.prop('checked'));

      // Update the selected predecessors display
      $(this).closest('.dropdown-menu').find('input:checked').each(function () {
        selectedPredecessors.push({
          name: $(this).data('no'),
          value: $(this).val()
        });
      });

      var buttonText = selectedPredecessors.length > 0 ? selectedPredecessors.map(item => item.name).join(', ') : 'Select Predecessors';
      $('#dropdownMenuButton-' + subActivityId).text(buttonText);
    });

    // Add event listener to the "Complete Schedule" button
    $('.complete-schedule').off('click').on('click', function (e) {
      e.preventDefault();

      // Check if any dropdown has no value selected
      var allDropdownsHaveValues = true;
      $('.dropdown-menu').each(function () {
        if ($(this).find('input:checked').length === 0) {
          allDropdownsHaveValues = false;
          return false; // Exit the loop early
        }
      });

      // If any dropdown has no value selected, alert the user
      if (!allDropdownsHaveValues) {
        alert('All dropdowns should have at least one input.');
        return;
      }
      let idArr = []
      let predecessorArr = []
      // Print the selected values (values associated with the names)
      $('.dropdown-menu').each(function () {
        var subActivityId = $(this).closest('.dropdown').find('.dropdown-toggle').attr('id').split('-')[1];
        var selectedValues = [];
        $(this).find('input:checked').each(function () {
          var name = $(this).data('no');
          var value = $(this).val();
          selectedValues.push(value);
        });
        console.log('Selected values for Sub Activity ' + subActivityId + ':', String(selectedValues));
        idArr.push(subActivityId)
        predecessorArr.push(selectedValues)
      });
      console.log(idArr)
      console.log(predecessorArr)
      $.ajax({
        method:'POST',
        url:'/api/set-predecessor',
        data: {
          ids: JSON.stringify(idArr),
          predecessors: JSON.stringify(predecessorArr),
        },
        success: function(response) {
          console.log(response);
          Swal.fire({
          title: "Predecessors have been set!",
          text: response.response,
          icon: "success"
        });
        window.setTimeout(function() {
          window.location.href = window.location.origin + "/user/ongoing-projects/"
        }, 3000);
        },
      })
    });
  });
</script>
<script>
  $('.view-pert').off('click').on('click', function (e) {
      e.preventDefault();

      // Check if any dropdown has no value selected
      var allDropdownsHaveValues = true;
      $('.dropdown-menu').each(function () {
        if ($(this).find('input:checked').length === 0) {
          allDropdownsHaveValues = false;
          return false; // Exit the loop early
        }
      });
      
      // If any dropdown has no value selected, alert the user
      if (!allDropdownsHaveValues) {
        alert('All dropdowns should have at least one input.');
        return;
      }

      $('#exampleModal').modal('show');
 
      let idArr = []
      let predecessorArr = []
      // Print the selected values (values associated with the names)
      $('.dropdown-menu').each(function () {
        var subActivityId = $(this).closest('.dropdown').find('.dropdown-toggle').attr('id').split('-')[1];
        var selectedValues = [];
        $(this).find('input:checked').each(function () {
          var name = $(this).data('no');
          var value = $(this).val();
          selectedValues.push(value);
        });
        console.log('Selected values for Sub Activity ' + subActivityId + ':', String(selectedValues));
        idArr.push(subActivityId)
        predecessorArr.push(selectedValues)
      });
      console.log(idArr)
      console.log(predecessorArr)
    });
</script>
{{ end }}